---
title: "PD - post vs control"
author: "Gitali Naim"
---
```{r workspace, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(tibble)
library(dplyr)
library(data.table)
library(tidyr)
library(ggplot2)
library(gplots)
library(ggthemes)
library(ggrepel)
library(pheatmap)
library(gridExtra)
library(patchwork)
library(openxlsx)
library(readxl)
library(RColorBrewer)
library(DESeq2)
library(Rtsne)
library(factoextra)
library(vegan)
library(biomaRt)
library(flowCore) 
library(corrplot)
library(psych)
library(DataExplorer)
library(apeglm)
library(GGally)
library(Rcpp)
library(EnrichmentBrowser)
library(mygene)
library(plotly)
#library(xlsx)
library(stringr)
library(EnhancedVolcano)
library("png")
library("plotly")
library(grid)
```

# Build a DESeq object
## Environment settings
```{r environment}
home_dir <- "C:/Users/labyissachar/Okun Lab Dropbox/Yissachar Lab/Personal folders/Gitali/Parkinson/Second_analysis/post vs ctrl"
# Create a directory for the results
DE_result_dir <- paste0(home_dir,"/results_",format(Sys.time(), "%F_%H-%M"))
if (!file.exists(DE_result_dir)) {dir.create(DE_result_dir)}

```

## Load the data
```{r}
# Count matrix - contains the number of each gene at each sample
cts <- read.csv("countdata.csv", header = TRUE, sep = ",", fileEncoding="UTF-8-BOM") 
# Metadata file
coldata <- read.csv("metadata.csv", header = TRUE, sep = ",", fileEncoding="UTF-8-BOM")
```

## Bulid a DESeq2 object
```{r deseq_object, warning=FALSE}
# Clean cts with invalid genes
cts <- subset(cts, Gene != "__no_feature" & Gene != "__ambiguous" & Gene != "__too_low_aQual" & Gene != "__not_aligned" & Gene != "__alignment_not_unique")
              
# Create a deseq object
dds <- DESeqDataSetFromMatrix(countData = cts,
                              colData = coldata,
                              design= ~PatientID + Group, tidy=TRUE)
```

## reference declaration + summary
```{r deseq_results, message=FALSE, warning=FALSE}
# Choose the reference group
dds$Group <- relevel(dds$Group, ref = "CTRL") 
# Activate DESeq function for run analysis
dds <- DESeq(dds)
# Returns the names of the estimated effects (coefficents) of the model
resultsNames(dds) #"Group_Post_vs_CTRL"
# Get the Pval, Padj and LFC for each gene
res <- results(dds)
# Print a summary of the results from a DESeq analysis
summary(res) # ~19000 genes
```

## Filter very low expressed genes + summary
```{r filtering, message=FALSE, warning=FALSE}
dds <- dds[rowMeans(counts(dds))>25, ]
dds <- DESeq(dds)
resultsNames(dds) 
res <- results(dds, name = "Group_Post_vs_CTRL")

summary(res) # ~12000 genes
```

# Gene list info
```{R}
res_treat <- results(dds, name = "Group_Post_vs_CTRL")
write.csv(res_treat,  file=paste0(DE_result_dir,"/Genes_info.csv"),
          row.names = FALSE)
```

# Quality control
## Histrograms
```{r Histrogram of FDR}
hist(res$padj)
```
```{r Histrogram of P-value}
hist(res$pvalue)
```

## PCA plots
### Before removing batch effect:
```{r PCA - before removing BE}
vsd <- vst(dds, blind=FALSE)
DESeq2::plotPCA(vsd, intgroup="Group") + geom_label(aes(label=name)) + labs(title = "PCA according to group - Before removing batch effect")
DESeq2::plotPCA(vsd, intgroup="PatientID") + geom_label(aes(label=name)) + labs(title = "PCA according to patient ID - Before removing batch effect")
```

### Remove the batch effect:
```{r}
mat <- assay(vsd)
mat <- limma::removeBatchEffect(mat, vsd$PatientID)# remove according to experiment
assay(vsd) <- mat
```

### After removing batch effect:
```{r PCA - after removing BE}
DESeq2::plotPCA(vsd, intgroup="Group") + geom_label(aes(label=name)) + labs(title = "PCA according to group - After removing batch effect")
DESeq2::plotPCA(vsd, intgroup="PatientID") + geom_label(aes(label=name)) + labs(title = "PCA according to patient ID - After removing batch effect")
```

```{r Samples Correlation Heatmap}
pheatmap(cor(assay(vsd)), main="Samples Correlation Heatmap")
```

# Up and down genes
FDR <= 0.1, pValue <= 0.05, threshold LFC=0.58
```{r sig_genes}
res_treat <- results(dds, name = "Group_Post_vs_CTRL")
res_df<- as.data.frame(res_treat)
thresh<-0.58
pVal<-0.05
pAdj<-0.1

# Padj = FDR correction - all the genes that Padj <= 0.1
gene_res_padj_sig <- subset(res_df, padj <= pAdj)
print(paste("gene_res_padj_sig:",nrow(gene_res_padj_sig)))

# Pval - all the genes that Pval <= 0.05
gene_res_pval_sig <- subset(res_df, pvalue <= pVal)
print(paste("gene_res_pval_sig:",nrow(gene_res_pval_sig)))

# Padj - all the genes that Padj<=0.1 and LFC>=thresh
gene_res_padj_sig <- subset(gene_res_padj_sig,abs(log2FoldChange) >=thresh)
print(paste("gene_res_padj_sig",thresh,":",nrow(gene_res_padj_sig)))

# Pval - all the genes that Pval<=0.05 and LFC>=thresh
gene_res_pval_sig <- subset(gene_res_pval_sig,abs(log2FoldChange) >=thresh)
print(paste("gene_res_pval_sig",thresh,":",nrow(gene_res_pval_sig)))

write.table(rownames(gene_res_padj_sig), 
              file = paste0(DE_result_dir,"/sig_genes_padj_lfc",".txt"),  
              sep = "\t", row.names = F, col.names = FALSE, quote = FALSE)

write.table(rownames(gene_res_pval_sig), 
              file = paste0(DE_result_dir,"/sig_genes_pval_lfc",".txt"),  
              sep = "\t", row.names = F, col.names = FALSE, quote = FALSE)

openxlsx::write.xlsx (gene_res_padj_sig, paste0(DE_result_dir,"/gene_res_padj_sig_all_data",".xlsx"),
                              rowNames = TRUE, colNames = TRUE) 

openxlsx::write.xlsx (gene_res_pval_sig, paste0(DE_result_dir,"/gene_res_pval_sig_all_data",".xlsx"),
                              rowNames = TRUE, colNames = TRUE) 
```

```{r}
top50pval <- gene_res_pval_sig
top50pval$log2FoldChange <- abs(top50pval$log2FoldChange)
top50pval <- top50pval[order(top50pval$log2FoldChange,  decreasing=TRUE),]
top50pval= row.names(top50pval)[1:50]
openxlsx::write.xlsx (as.factor(top50pval), paste0(DE_result_dir,"/top50pval",".xlsx"))

top50padj <- gene_res_padj_sig
top50padj$log2FoldChange <- abs(top50padj$log2FoldChange)
top50padj <- top50padj[order(top50padj$log2FoldChange,  decreasing=TRUE),]
top50padj= row.names(top50padj)[1:50]
openxlsx::write.xlsx (as.factor(top50padj), paste0(DE_result_dir,"/top50padj",".xlsx"))

```

# Data to Metascape
```{r Metascape}
#creating a csv file with all the values with pval<.05 & log2FoldChange>=0.58 from yellow light VS. blue light for down regulated genes
res <- results(dds, name="Group_Post_vs_CTRL")

x<-subset(res, pvalue<=pVal & log2FoldChange>=thresh)
x<-row.names(as.data.frame(x))
write.csv(x, file=paste0(DE_result_dir,"/Up_Regulated_Genes_pval.csv"),
          row.names = FALSE)

#creating a csv file with all the values with pval<.05 & log2FoldChange<=-0.58 from yellow light VS blue light for up regulated genes
x<-subset(res, pvalue<=pVal & log2FoldChange<=-1*thresh)
x<-row.names(as.data.frame(x))
write.csv(x, file=paste0(DE_result_dir,"/Down_Regulated_Genes_pval.csv"),
          row.names = FALSE)

x<-subset(res, padj<=pAdj & log2FoldChange>=thresh)
x<-row.names(as.data.frame(x))
write.csv(x, file=paste0(DE_result_dir,"/Up_Regulated_Genes_FDR.csv"),
          row.names = FALSE)

#creating a csv file with all the values with pval<.05 & log2FoldChange<=-0.58 from yellow light VS blue light for up regulated genes
x<-subset(res, padj<=pAdj & log2FoldChange<=-1*thresh)
x<-row.names(as.data.frame(x))
write.csv(x, file=paste0(DE_result_dir,"/Down_Regulated_Genes_FDR.csv"),
          row.names = FALSE)


```

# Volcano plot
## Significant genes with FDR <= 0.1
```{r Volcano plot FDR}
EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'padj', labSize = 3.0,
    legendLabSize = 10,
    legendIconSize = 3.5,
    FCcutoff = thresh, pCutoff = pAdj)
```

## Significant genes with P-value <= 0.05
```{r Volcano plot P-value}
EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue', labSize = 3.0,
    legendLabSize = 10,
    legendIconSize = 3.5,
    FCcutoff = thresh, pCutoff = pVal)


```
# Heatmaps
```{r,message=FALSE, warning=FALSE, results='hide'}
my_palette <- colorRampPalette(c("blue", "white", "red"))(n = 50)

cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
}

save_pheatmap_png <- function(x,file, width=1200, height=2500, res = 150) {
  png(file=file, width = width, height = height, res = res)
  grid::grid.newpage()
  grid::grid.draw(x$gtable)
  dev.off()
}
```

## Significant genes with pValue <= 0.05 and threshold LFC=0.58
```{r Heatmap P-Value,message=FALSE, warning=FALSE, results='hide'}
select = which((res$pvalue <=pVal) & (abs(res$log2FoldChange) >= thresh))
heatmap_df_all = assay(vsd)[select,]

data_subset_norm_all <- t(apply(heatmap_df_all, 1, cal_z_score))
my_sample_col <- data.frame(group = rep(c("CTRL", "Post"), c(8,8)))
row.names(my_sample_col) <- colnames(heatmap_df_all)

pheatmap(data_subset_norm_all,cluster_cols = FALSE, color = my_palette, annotation_col = my_sample_col,main= paste("sig genes pvalue <= 0.05 and threshold LFC=0.58 ",nrow(data_subset_norm_all)), fontsize_row=5)
```

## Up genes with significant P-value
```{r  Up genes Pval,message=FALSE, warning=FALSE, results='hide'}
select = which((res$pvalue <=pVal) & (res$log2FoldChange) >= thresh)
heatmap_df_up_pval = assay(vsd)[select,]

data_subset_norm <- t(apply(heatmap_df_up_pval, 1, cal_z_score))
my_sample_col <- data.frame(group = rep(c("CTRL", "Post"), c(8,8)))
row.names(my_sample_col) <- colnames(heatmap_df_up_pval)

pheatmap(data_subset_norm, color = my_palette,cluster_cols = FALSE, annotation_col = my_sample_col,main= paste("UP sig genes pvalue <= 0.05 and threshold LFC=0.58 ",nrow(data_subset_norm)))
```

## Down genes with significant pValue
```{r  Down genes Pval,message=FALSE, warning=FALSE, results='hide'}
select = which((res$pvalue <=pVal) & (res$log2FoldChange) <= -1*thresh)
heatmap_df_down_pval = assay(vsd)[select,]

data_subset_norm <- t(apply(heatmap_df_down_pval, 1, cal_z_score))
my_sample_col <- data.frame(group = rep(c("CTRL", "Post"), c(8,8)))
row.names(my_sample_col) <- colnames(heatmap_df_down_pval)

pheatmap(data_subset_norm, cluster_cols =FALSE, color = my_palette, annotation_col = my_sample_col,main= paste("DOWN sig genes pvalue <= 0.05 and threshold LFC=0.58 ",nrow(data_subset_norm)))
```

## Up & Down genes with significant pValue
```{r Up Down genes pval,message=FALSE, warning=FALSE, results='hide'}
up<- data.frame(up_down = rep(c("up"), c(nrow(heatmap_df_up_pval))))
row.names(up) <- rownames(heatmap_df_up_pval)
down <- data.frame(up_down = rep(c("down"), c(nrow(heatmap_df_down_pval))))
row.names(down) <- rownames(heatmap_df_down_pval)
up_down_genes <- rbind(up,down)

p2<-pheatmap(data_subset_norm_all, cluster_cols=F,color = my_palette, annotation_row = up_down_genes,  annotation_col = my_sample_col,main= paste("UP & DOWN sig genes pvalue <= 0.05 and threshold LFC=0.58 ",nrow(data_subset_norm_all)))

save_pheatmap_png(p2,file = paste(DE_result_dir,"heatmap_pval_2.png",sep="/"))

```

## Significant genes with FDR <= 0.1 and threshold LFC=0.58
```{r Heatmap padj,message=FALSE, warning=FALSE, results='hide'}
select = which((res$padj <=pAdj) & (abs(res$log2FoldChange) >= thresh))
heatmap_df_all = assay(vsd)[select,]

data_subset_norm_all <- t(apply(heatmap_df_all, 1, cal_z_score))
my_sample_col <- data.frame(group = rep(c("CTRL", "Post"), c(8,8)))
row.names(my_sample_col) <- colnames(heatmap_df_all)

pheatmap(data_subset_norm_all,cluster_cols = FALSE, color = my_palette, annotation_col = my_sample_col,main= paste("sig genes FDR <= 0.1 and threshold LFC=0.58 ",nrow(data_subset_norm_all)), fontsize_row=5)
```

## Up genes with significant padj
```{r  Up genes padj,message=FALSE, warning=FALSE, results='hide'}
select = which((res$padj <=pAdj) & (res$log2FoldChange) >= thresh)
heatmap_df_up_pval = assay(vsd)[select,]

data_subset_norm <- t(apply(heatmap_df_up_pval, 1, cal_z_score))
my_sample_col <- data.frame(group = rep(c("CTRL", "Post"), c(8,8)))
row.names(my_sample_col) <- colnames(heatmap_df_up_pval)

pheatmap(data_subset_norm, color = my_palette,cluster_cols = FALSE, annotation_col = my_sample_col,main= paste("UP sig genes FDR <= 0.1 and threshold LFC=0.58 ",nrow(data_subset_norm)))
```

## Down genes with significant padj
```{r  Down genes padj,message=FALSE, warning=FALSE, results='hide'}
select = which((res$padj <=pAdj) & (res$log2FoldChange) <= -1*thresh)
heatmap_df_down_pval = assay(vsd)[select,]

data_subset_norm <- t(apply(heatmap_df_down_pval, 1, cal_z_score))
my_sample_col <- data.frame(group = rep(c("CTRL", "Post"), c(8,8)))
row.names(my_sample_col) <- colnames(heatmap_df_down_pval)

pheatmap(data_subset_norm, cluster_cols =FALSE, color = my_palette, annotation_col = my_sample_col,main= paste("DOWN sig genes FDR <= 0.1 and threshold LFC=0.58 ",nrow(data_subset_norm)))
```

## Up & Down genes with significant padj
```{r Up Down genes padj,message=FALSE, warning=FALSE, results='hide'}
up<- data.frame(up_down = rep(c("up"), c(nrow(heatmap_df_up_pval))))
row.names(up) <- rownames(heatmap_df_up_pval)
down <- data.frame(up_down = rep(c("down"), c(nrow(heatmap_df_down_pval))))
row.names(down) <- rownames(heatmap_df_down_pval)
up_down_genes <- rbind(up,down)

p2<-pheatmap(data_subset_norm_all, cluster_cols=F,color = my_palette, annotation_row = up_down_genes,  annotation_col = my_sample_col,main= paste("UP & DOWN sig genes FDR <= 0.1 and threshold LFC=0.58 ",nrow(data_subset_norm_all)))


save_pheatmap_png(p1,file = paste(DE_result_dir,"heatmap_padj_1.png",sep="/"))
```
